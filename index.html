<script>
  // Retorna “YYYY-MM-DD” do dia atual
  function hojeStr() {
    const hj = new Date();
    return hj.toISOString().split("T")[0];
  }
  // Retorna “HH:MM” zero-padded
  function horaAtualStr() {
    const hj = new Date();
    const horas = String(hj.getHours()).padStart(2, "0");
    const mins = String(hj.getMinutes()).padStart(2, "0");
    return `${horas}:${mins}`;
  }

  async function carregarAgenda() {
    try {
      const res = await fetch("/api/agenda");
      if (!res.ok) {
        throw new Error("API retornou " + res.status);
      }
      const dados = await res.json();
      const container = document.getElementById("agenda");
      container.innerHTML = "";  // limpa
      document.getElementById("erro").innerText = "";

      const hoje = hojeStr();
      const horaAgora = horaAtualStr();

      // Filtra dias a partir de hoje
      const diasFuturos = dados.filter(d => d.data >= hoje);

      // Para cada dia, cria um card com header e grid de blocos
      diasFuturos.forEach(diaObj => {
        // Card do dia
        const diaCard = document.createElement("div");
        diaCard.className = "dia-card";

        // Header do dia
        const diaHeader = document.createElement("div");
        diaHeader.className = "dia-header";
        diaHeader.innerText = diaObj.data;
        diaCard.appendChild(diaHeader);

        // Grid de blocos (2 colunas em desktop, 1 em mobile)
        const grid = document.createElement("div");
        grid.className = "blocos-grid";

        diaObj.blocos.forEach(bloco => {
          // Se for o dia atual, só mostra blocos cujo início >= hora atual
          if (diaObj.data === hoje && bloco.inicio < horaAgora) {
            return;
          }

          const divSlot = document.createElement("div");
          divSlot.className = "slot " + bloco.status;
          divSlot.innerHTML = `
            <span class="label">${bloco.inicio} – ${bloco.fim}</span>
            <span class="status">${bloco.status.charAt(0).toUpperCase() + bloco.status.slice(1)}</span>
          `;

          // Chama marcarEvento se estiver disponível
          if (bloco.status === "disponível") {
            divSlot.onclick = () => marcarEvento(diaObj.data, bloco.inicio, bloco.fim);
          }

          grid.appendChild(divSlot);
        });

        // Se não houver blocos (todos passaram), mostra mensagem
        if (grid.childElementCount === 0) {
          const vazio = document.createElement("p");
          vazio.style.textAlign = "center";
          vazio.style.marginTop = "12px";
          vazio.style.color = "#777";
          vazio.innerText = "Sem horários disponíveis hoje.";
          diaCard.appendChild(vazio);
        } else {
          diaCard.appendChild(grid);
        }

        document.getElementById("agenda").appendChild(diaCard);
      });

      // Se não houver nenhum dia futuro, mostra mensagem geral
      if (diasFuturos.length === 0) {
        document.getElementById("agenda").innerHTML = "<p style='text-align:center;color:#777;margin-top:20px;'>Sem dados de disponibilidade para os próximos dias.</p>";
      }

    } catch (e) {
      document.getElementById("erro").innerText = "Erro ao carregar disponibilidade.";
      console.error("Erro no carregarAgenda():", e);
    }
  }

  // Função que tenta marcar o evento e exibe erros detalhados
  async function marcarEvento(data, inicio, fim) {
    const confirmado = confirm(`Queres marcar um evento para ${data} das ${inicio} às ${fim}?`);
    if (!confirmado) return;

    const evento = {
      titulo: "Marcado via app",   // podes personalizar o título
      data_inicio: data,
      hora_inicio: inicio,
      hora_fim: fim
    };

    try {
      const res = await fetch("/api/create-event", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(evento)
      });

      if (!res.ok) {
        // Tenta ler JSON de erro: { error: "...", details: "..." }
        const erroJson = await res.json().catch(() => null);
        if (erroJson && (erroJson.error || erroJson.details)) {
          throw new Error(`Status ${res.status}:\n${erroJson.error || ""}${erroJson.details ? "\nDetalhes: " + erroJson.details : ""}`);
        }
        // Fallback para texto bruto
        const textoErro = await res.text();
        throw new Error(`Status ${res.status}: ${textoErro}`);
      }

      alert("✅ Evento marcado com sucesso!");
      carregarAgenda(); // Recarrega a agenda para atualizar a cor do slot
    } catch (err) {
      alert("❌ Erro ao marcar evento:\n" + err.message);
      console.error("Erro no marcarEvento():", err);
    }
  }

  // Carrega a agenda ao abrir a página
  carregarAgenda();
</script>

